const SawitClient = require('../src/SawitClient');
const net = require('net');
const assert = require('assert');

// Config
const PORT = 7999;
const HOST = '127.0.0.1';

// We need to spawn a server instance for testing
const { spawn } = require('child_process');
const path = require('path');

let serverProcess;

function startServer() {
    return new Promise((resolve, reject) => {
        const serverPath = path.join(__dirname, '../bin/sawit-server.js');
        serverProcess = spawn('node', [serverPath], {
            env: { ...process.env, SAWIT_PORT: PORT, SAWIT_AUTH: 'admin:admin123' }, // Enable Auth
            stdio: 'pipe'
        });

        serverProcess.stdout.on('data', (data) => {
            if (data.toString().includes('Ready to accept connections')) {
                resolve();
            }
        });

        serverProcess.stderr.on('data', (data) => console.error(`SERVER ERR: ${data}`));
    });
}

function stopServer() {
    if (serverProcess) serverProcess.kill();
}

async function testPathTraversal() {
    console.log('[TEST] Path Traversal...');
    const client = new SawitClient(`sawitdb://admin:admin123@${HOST}:${PORT}/default`);
    await client.connect();

    try {
        await client.query('BUKA WILAYAH ../../evil_db');
        console.error('❌ FAIL: Allowed path traversal in DB creation');
    } catch (e) {
        if (e.message.includes('Invalid database name') || e.message.includes('Nama wilayah hanya boleh')) {
            console.log('✅ PASS: Blocked DB creation path traversal');
        } else {
            console.error(`❌ FAIL: Unexpected error: ${e.message}`);
        }
    }

    try {
        await client.query('BAKAR WILAYAH ../../evil_db');
        console.error('❌ FAIL: Allowed path traversal in DB drop');
    } catch (e) {
        if (e.message.includes('Invalid database name') || e.message.includes('Nama wilayah hanya boleh')) {
            console.log('✅ PASS: Blocked DB drop path traversal');
        } else {
            console.error(`❌ FAIL: Unexpected error: ${e.message}`);
        }
    }
    client.disconnect();
}

async function testSQLInjection() {
    console.log('[TEST] SQL Injection / Regex Safety...');
    const client = new SawitClient(`sawitdb://admin:admin123@${HOST}:${PORT}/default`);
    await client.connect();

    // Create table
    try { await client.query('LAHAN users'); } catch (e) { }
    try { await client.query("TANAM KE users (id, name) BIBIT (1, 'Alice')"); } catch (e) { }

    // Try LIKE injection
    // Sending a payload that might break regex if not escaped
    try {
        // Attempt ReDoS pattern if not escaped: (a+)+
        // We send many % to see if it hangs or matches incorrectly? 
        // Or send regex chars like [ ] ( )
        const result = await client.query("PANEN * DARI users DIMANA name LIKE 'Alice.([a-z]+)*'");
        // Should treat strictly as string literals due to escaping
        console.log('✅ PASS: Regex chars treated as literals (no crash/error)');
    } catch (e) {
        console.error(`❌ FAIL: Regex injection error: ${e.message}`);
    }

    client.disconnect();
}

async function testDoSBuffer() {
    console.log('[TEST] DoS Buffer Overflow...');
    return new Promise((resolve) => {
        const client = new net.Socket();
        client.connect(PORT, HOST, () => {
            // Send 2MB of junk
            const hugePayload = 'A'.repeat(2 * 1024 * 1024);
            client.write(hugePayload);
        });

        client.on('data', (data) => {
            const msg = data.toString();
            if (msg.includes('error') && msg.includes('limit')) { // Or connection closed
                /* It might close immediately */
            }
        });

        client.on('close', () => {
            console.log('✅ PASS: Server closed connection on buffer overflow');
            resolve();
        });

        client.on('error', (err) => {
            // Connection reset is good
            console.log('✅ PASS: Connection reset by server');
            resolve();
        });
    });
}

async function run() {
    try {
        console.log('Starting Security Tests...');
        await startServer();
        console.log('Server started.');

        await testPathTraversal();
        await testSQLInjection();
        await testDoSBuffer();

        console.log('\nAll Security Tests Completed.');
    } catch (e) {
        console.error('Test Suite Failed:', e);
    } finally {
        stopServer();
        process.exit(0);
    }
}

run();
